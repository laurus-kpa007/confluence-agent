<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Confluence Knowledge Agent</title>
  <style>
    :root {
      --bg: #1a1a2e;
      --surface: #16213e;
      --surface2: #0f3460;
      --accent: #e94560;
      --accent2: #533483;
      --text: #eee;
      --text2: #aab;
      --border: #2a2a4a;
      --success: #4ade80;
      --warn: #fbbf24;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      font-family: -apple-system, 'Pretendard', 'Segoe UI', sans-serif;
      background-color: #1a1a2e !important;
      color: #eee !important;
      min-height: 100vh;
      width: 100%;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    header {
      display: flex; align-items: center; gap: 16px;
      padding: 16px 0; border-bottom: 1px solid var(--border);
      margin-bottom: 24px;
    }
    header h1 { font-size: 1.5em; }
    header .badge {
      background: var(--accent); padding: 4px 12px; border-radius: 12px;
      font-size: 0.8em; font-weight: 600;
    }

    /* Layout */
    .main-grid {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 24px;
      height: calc(100vh - 120px);
    }

    /* Left panel */
    .panel {
      background: var(--surface);
      border-radius: 12px;
      padding: 20px;
      overflow-y: auto;
    }
    .panel h2 {
      font-size: 1.1em; margin-bottom: 16px;
      display: flex; align-items: center; gap: 8px;
    }

    /* Source input */
    .source-input {
      display: flex; gap: 8px; margin-bottom: 12px;
    }
    .source-input input {
      flex: 1; padding: 10px 14px;
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text); font-size: 0.9em;
    }
    .source-input input:focus { outline: none; border-color: var(--accent); }

    .source-list {
      list-style: none; margin-bottom: 20px;
    }
    .source-list li {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 12px; margin-bottom: 4px;
      background: var(--bg); border-radius: 6px; font-size: 0.85em;
    }
    .source-list .type-badge {
      font-size: 0.7em; padding: 2px 8px; border-radius: 4px;
      background: var(--accent2); margin-right: 8px;
    }
    .source-list .remove { cursor: pointer; color: var(--accent); }

    /* Options */
    .option-group { margin-bottom: 16px; }
    .option-group label {
      display: block; font-size: 0.85em; color: var(--text2);
      margin-bottom: 6px;
    }
    select, input[type="text"] {
      width: 100%; padding: 8px 12px;
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 6px; color: var(--text); font-size: 0.9em;
    }

    /* Buttons */
    .btn {
      padding: 10px 20px; border: none; border-radius: 8px;
      font-size: 0.9em; font-weight: 600; cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { opacity: 0.9; }
    .btn-secondary { background: var(--surface2); color: var(--text); }
    .btn-secondary:hover { background: var(--accent2); }
    .btn-success { background: var(--success); color: #111; }
    .btn-success:hover { opacity: 0.9; }
    .btn-group { display: flex; gap: 8px; margin-top: 16px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Right panel - Preview */
    .preview-panel {
      display: flex; flex-direction: column;
    }
    .preview-tabs {
      display: flex; gap: 4px; margin-bottom: 12px;
    }
    .preview-tab {
      padding: 8px 16px; background: var(--surface);
      border-radius: 8px 8px 0 0; cursor: pointer;
      font-size: 0.85em; color: var(--text2);
    }
    .preview-tab.active {
      background: var(--surface2); color: var(--text);
    }
    .preview-content {
      flex: 1; background: var(--surface);
      border-radius: 0 12px 12px 12px;
      overflow: hidden; position: relative;
    }
    .preview-rendered {
      padding: 24px; overflow-y: auto; height: 100%;
      line-height: 1.7;
    }
    .preview-rendered h1, .preview-rendered h2, .preview-rendered h3 {
      margin: 16px 0 8px; color: var(--accent);
    }
    .preview-rendered table {
      border-collapse: collapse; width: 100%; margin: 12px 0;
    }
    .preview-rendered th, .preview-rendered td {
      border: 1px solid var(--border); padding: 8px 12px; text-align: left;
    }
    .preview-rendered th { background: var(--surface2); }
    .preview-rendered code {
      background: var(--bg); padding: 2px 6px; border-radius: 4px;
      font-size: 0.9em;
    }
    .preview-rendered pre {
      background: var(--bg); padding: 16px; border-radius: 8px;
      overflow-x: auto; margin: 12px 0;
    }
    .preview-rendered a { color: var(--accent); }
    .preview-rendered ul, .preview-rendered ol { padding-left: 24px; }

    .preview-source {
      padding: 16px; height: 100%;
    }
    .preview-source textarea {
      width: 100%; height: 100%;
      background: var(--bg); color: var(--text);
      border: 1px solid var(--border); border-radius: 8px;
      padding: 16px; font-family: 'Consolas', monospace;
      font-size: 0.85em; resize: none; line-height: 1.6;
    }

    /* Publish bar */
    .publish-bar {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 20px; background: var(--surface);
      border-radius: 12px; margin-top: 12px;
    }
    .publish-bar input { flex: 1; }
    .publish-bar .format-toggle {
      display: flex; gap: 4px;
    }
    .format-toggle button {
      padding: 6px 12px; background: var(--bg);
      border: 1px solid var(--border); border-radius: 4px;
      color: var(--text2); cursor: pointer; font-size: 0.8em;
    }
    .format-toggle button.active {
      background: var(--accent2); border-color: var(--accent2);
      color: white;
    }

    /* Status */
    .status {
      padding: 12px 16px; border-radius: 8px;
      font-size: 0.85em; margin-top: 12px;
    }
    .status.loading { background: var(--surface2); color: var(--warn); }
    .status.success { background: #1a3a2a; color: var(--success); }
    .status.error { background: #3a1a1a; color: var(--accent); }

    /* Progress */
    .progress-container {
      margin-top: 8px;
    }
    .progress-bar {
      width: 100%; height: 6px;
      background: var(--bg); border-radius: 3px;
      overflow: hidden; margin-bottom: 8px;
    }
    .progress-fill {
      height: 100%; background: linear-gradient(90deg, var(--accent2), var(--accent));
      transition: width 0.3s ease;
      border-radius: 3px;
    }
    .progress-steps {
      display: flex; flex-direction: column; gap: 4px;
      font-size: 0.75em; color: var(--text2);
    }
    .progress-step {
      display: flex; align-items: center; gap: 8px;
      padding: 4px 0;
    }
    .progress-step.active { color: var(--warn); font-weight: 600; }
    .progress-step.done { color: var(--success); }
    .progress-step .icon { width: 16px; text-align: center; }

    /* Template editor modal */
    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.7); z-index: 100;
      justify-content: center; align-items: center;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: var(--surface); border-radius: 16px;
      padding: 24px; width: 700px; max-height: 80vh;
      overflow-y: auto;
    }
    .modal h2 { margin-bottom: 16px; }
    .modal textarea {
      width: 100%; height: 400px;
      background: var(--bg); color: var(--text);
      border: 1px solid var(--border); border-radius: 8px;
      padding: 16px; font-family: monospace; font-size: 0.85em;
      resize: vertical;
    }
    .modal .btn-group { justify-content: flex-end; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ“š Confluence Knowledge Agent</h1>
      <span class="badge">v0.1</span>
    </header>

    <div class="main-grid">
      <!-- Left Panel: Sources & Options -->
      <div class="panel">
        <h2>ğŸ“¥ ì†ŒìŠ¤ ì…ë ¥</h2>

        <div class="source-input">
          <input type="text" id="sourceInput" placeholder="URL, ê²€ìƒ‰ì–´ (ìë™ ê²€ìƒ‰), search:ê²€ìƒ‰ì–´, íŒŒì¼ ê²½ë¡œ..."
                 onkeydown="if(event.key==='Enter') addSource()">
          <button class="btn btn-primary" onclick="addSource()">+</button>
        </div>

        <div style="font-size:0.75em; color:var(--text2); margin-bottom:12px; padding:0 4px;">
          ğŸ’¡ íŒ: ì¼ë°˜ í…ìŠ¤íŠ¸ëŠ” ìë™ìœ¼ë¡œ ì›¹ ê²€ìƒ‰ë©ë‹ˆë‹¤
        </div>

        <ul class="source-list" id="sourceList"></ul>

        <div class="option-group">
          <label>ğŸ“ í…œí”Œë¦¿</label>
          <div style="display:flex; gap:8px;">
            <select id="templateSelect" style="flex:1;"></select>
            <button class="btn btn-secondary" onclick="openTemplateEditor()" title="í…œí”Œë¦¿ í¸ì§‘">âœï¸</button>
          </div>
        </div>

        <div class="option-group">
          <label>ğŸ“¤ ì¶œë ¥ í¬ë§·</label>
          <select id="formatSelect">
            <option value="markdown">ë§ˆí¬ë‹¤ìš´ (Markdown ë§¤í¬ë¡œ)</option>
            <option value="confluence">Confluence XHTML</option>
          </select>
        </div>

        <div class="option-group">
          <label>ğŸ“ ì¶œë ¥ ê¸¸ì´</label>
          <select id="lengthSelect">
            <option value="compact">ê°„ê²° (50% - í•µì‹¬ë§Œ)</option>
            <option value="normal" selected>ë³´í†µ (100% - ê¸°ë³¸)</option>
            <option value="detailed">ìƒì„¸ (200% - ì˜ˆì‹œ í¬í•¨)</option>
            <option value="comprehensive">ë§¤ìš° ìƒì„¸ (300% - ëª¨ë“  ì„¸ë¶€ì‚¬í•­)</option>
          </select>
        </div>

        <div class="option-group">
          <label>ğŸ¤– LLM</label>
          <select id="llmSelect">
            <option value="ollama">Ollama (ë¡œì»¬)</option>
            <option value="anthropic">Claude (í´ë¼ìš°ë“œ)</option>
          </select>
        </div>

        <div class="option-group">
          <label>ğŸ”¬ LangExtract êµ¬ì¡°í™” ì¶”ì¶œ</label>
          <div style="display:flex; gap:8px; align-items:center;">
            <input type="checkbox" id="useLangExtract" style="width:auto;">
            <select id="extractProfile" style="flex:1;">
              <option value="general">ì¼ë°˜</option>
              <option value="meeting">íšŒì˜ë¡</option>
              <option value="tech_review">ê¸°ìˆ  ë¦¬ë·°</option>
              <option value="research">ë¦¬ì„œì¹˜</option>
            </select>
          </div>
          <div style="font-size:0.75em; color:var(--text2); margin-top:4px;">
            í…ìŠ¤íŠ¸ì—ì„œ í•µì‹¬ ì—”í‹°í‹°ë¥¼ ë¨¼ì € ì¶”ì¶œ í›„ LLM ì •ë¦¬
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="processAll()" id="processBtn" style="flex:1;">
            ğŸš€ ìƒì„±í•˜ê¸°
          </button>
          <button class="btn btn-secondary" onclick="openEntitiesViewer()" title="ì—”í‹°í‹° ë·°ì–´ (ìƒˆ íƒ­)">
            ğŸ“¦
          </button>
          <button class="btn btn-secondary" onclick="runVisualization()" id="vizBtn" title="LangExtract ì‹œê°í™”">
            ğŸ”¬
          </button>
        </div>

        <div id="status"></div>
      </div>

      <!-- Right Panel: Preview -->
      <div class="preview-panel">
        <div class="preview-tabs">
          <div class="preview-tab active" onclick="switchTab('rendered')">ğŸ‘ í”„ë¦¬ë·°</div>
          <div class="preview-tab" onclick="switchTab('source')">ğŸ“ ì†ŒìŠ¤ í¸ì§‘</div>
        </div>

        <div class="preview-content">
          <div class="preview-rendered" id="previewRendered">
            <p style="color: var(--text2); text-align: center; margin-top: 40%;">
              ì†ŒìŠ¤ë¥¼ ì¶”ê°€í•˜ê³  "ìƒì„±í•˜ê¸°"ë¥¼ í´ë¦­í•˜ì„¸ìš”
            </p>
          </div>
          <div class="preview-source" id="previewSource" style="display:none;">
            <textarea id="sourceEditor" placeholder="ìƒì„±ëœ ë§ˆí¬ë‹¤ìš´/XHTMLì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. ì§ì ‘ í¸ì§‘ ê°€ëŠ¥í•©ë‹ˆë‹¤."></textarea>
          </div>
        </div>

        <!-- Publish bar -->
        <div class="publish-bar publish-section" style="flex-wrap:wrap;">
          <input type="text" id="pageTitle" placeholder="í˜ì´ì§€ ì œëª©" style="flex:1; min-width:200px;">
          <select id="spaceSelect" style="width:160px;" onchange="onSpaceChange()">
            <option value="">Space ì„ íƒ...</option>
          </select>
          <select id="parentSelect" style="width:200px;">
            <option value="">ìƒìœ„ í˜ì´ì§€ (ìµœìƒìœ„)</option>
          </select>
          <input type="text" id="pageSearch" placeholder="ğŸ” í˜ì´ì§€ ê²€ìƒ‰" style="width:150px;"
                 oninput="debounceSearch()" />
          <div class="format-toggle">
            <button id="fmtMd" class="active" onclick="setPublishFormat('markdown')">MD</button>
            <button id="fmtConf" onclick="setPublishFormat('confluence')">XHTML</button>
          </div>
          <button class="btn btn-success" onclick="publishToConfluence()" id="publishBtn" disabled>
            ğŸ“¤ ê²Œì‹œ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Visualization Modal -->
  <div class="modal-overlay" id="vizModal">
    <div class="modal" style="width:90vw; max-width:1200px; max-height:90vh;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h2>ğŸ”¬ LangExtract êµ¬ì¡°í™” ì¶”ì¶œ ì‹œê°í™”</h2>
        <div>
          <button class="btn btn-secondary" onclick="openVizNewTab()" style="margin-right:8px;">â†— ìƒˆ íƒ­</button>
          <button class="btn btn-secondary" onclick="closeVizModal()">âœ•</button>
        </div>
      </div>
      <div id="vizEntities" style="margin-bottom:12px; font-size:0.85em; color:var(--text2);"></div>
      <iframe id="vizFrame" style="width:100%; height:70vh; border:1px solid var(--border); border-radius:8px; background:white;"></iframe>
    </div>
  </div>

  <!-- Template Editor Modal -->
  <div class="modal-overlay" id="templateModal">
    <div class="modal">
      <h2>âœï¸ í…œí”Œë¦¿ í¸ì§‘</h2>
      <div class="option-group">
        <label>í…œí”Œë¦¿ ì´ë¦„</label>
        <input type="text" id="tmplName" placeholder="ìƒˆ í…œí”Œë¦¿ ì´ë¦„">
      </div>
      <textarea id="tmplEditor"></textarea>
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="closeTemplateEditor()">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="saveTemplate()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- Markdown rendering - inline fallback if CDN fails -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    // Fallback: if marked didn't load from CDN, provide a simple markdown renderer
    if (typeof marked === 'undefined') {
      window.marked = {
        parse: function(md) {
          return md
            .replace(/^### (.*$)/gm, '<h3>$1</h3>')
            .replace(/^## (.*$)/gm, '<h2>$1</h2>')
            .replace(/^# (.*$)/gm, '<h1>$1</h1>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code>$1</code>')
            .replace(/\n/g, '<br>');
        }
      };
    }
  </script>
  <script>
    // State
    let sources = [];
    let generatedBody = '';
    let publishFormat = 'markdown';

    // --- Sources ---
    function addSource() {
      const input = document.getElementById('sourceInput');
      const val = input.value.trim();
      if (!val) return;
      sources.push(val);
      input.value = '';
      renderSources();
    }

    function removeSource(i) {
      sources.splice(i, 1);
      renderSources();
    }

    function detectType(s) {
      if (s.startsWith('search:')) return 'ğŸ”';
      if (s.match(/youtu/)) return 'ğŸ¬';
      if (s.match(/drive\.google|gdrive:/)) return 'ğŸ“';
      if (s.match(/sharepoint|onedrive/)) return 'â˜ï¸';
      if (s.match(/^https?:/)) return 'ğŸŒ';
      return 'ğŸ“„';
    }

    function renderSources() {
      const ul = document.getElementById('sourceList');
      ul.innerHTML = sources.map((s, i) => `
        <li>
          <span><span class="type-badge">${detectType(s)}</span>${s.length > 50 ? s.slice(0,50)+'...' : s}</span>
          <span class="remove" onclick="removeSource(${i})">âœ•</span>
        </li>
      `).join('');
    }

    // --- Templates ---
    async function loadTemplates() {
      const resp = await fetch('/api/templates');
      const templates = await resp.json();
      const sel = document.getElementById('templateSelect');
      sel.innerHTML = templates.map(t =>
        `<option value="${t.name}">${t.name}</option>`
      ).join('');
    }

    async function openTemplateEditor() {
      const name = document.getElementById('templateSelect').value;
      const resp = await fetch(`/api/templates/${name}`);
      const data = await resp.json();
      document.getElementById('tmplName').value = data.name;
      document.getElementById('tmplEditor').value = data.content;
      document.getElementById('templateModal').classList.add('show');
    }

    function closeTemplateEditor() {
      document.getElementById('templateModal').classList.remove('show');
    }

    async function saveTemplate() {
      const name = document.getElementById('tmplName').value.trim();
      const content = document.getElementById('tmplEditor').value;
      if (!name) return;

      await fetch(`/api/templates/${name}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({content}),
      });
      closeTemplateEditor();
      loadTemplates();
      setStatus('success', `í…œí”Œë¦¿ "${name}" ì €ì¥ ì™„ë£Œ`);
    }

    // --- Process ---
    async function processAll() {
      if (!sources.length) return;

      const btn = document.getElementById('processBtn');
      btn.disabled = true;

      try {
        const template = document.getElementById('templateSelect').value;
        const format = document.getElementById('formatSelect').value;
        const useLangExtract = document.getElementById('useLangExtract').checked;
        const extractProfile = document.getElementById('extractProfile').value;

        // Step 1: Extracting sources
        updateProgress(1, 3, 'ğŸ“¥ ì†ŒìŠ¤ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì¤‘...');

        // Simulate progress (since we can't track real server progress)
        const progressInterval = setInterval(() => {
          // This will be cleared when response arrives
        }, 100);

        const startTime = Date.now();

        const outputLength = document.getElementById('lengthSelect').value;

        const resp = await fetch('/api/process', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            sources,
            template,
            format,
            use_langextract: useLangExtract,
            extraction_profile: extractProfile,
            output_length: outputLength
          }),
        });

        clearInterval(progressInterval);

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${resp.status}): ${text.substring(0, 200)}`);
        }

        // Step 2: Processing with LLM
        updateProgress(2, 3, 'ğŸ¤– LLMìœ¼ë¡œ ì •ë¦¬ ì¤‘...');

        const data = await resp.json();
        generatedBody = data.body;

        // Step 3: Formatting
        updateProgress(3, 3, 'âœ¨ ìµœì¢… í¬ë§·íŒ… ì¤‘...');

        // Update preview
        updatePreview();
        document.getElementById('sourceEditor').value = generatedBody;
        document.getElementById('publishBtn').disabled = false;

        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        setStatus('success', `âœ… ìƒì„± ì™„ë£Œ (${data.sources_count}ê°œ ì†ŒìŠ¤, ${generatedBody.length}ì, ${elapsed}ì´ˆ ì†Œìš”)`);
      } catch (e) {
        setStatus('error', `âŒ ì˜¤ë¥˜: ${e.message}`);
      }

      btn.disabled = false;
    }

    function updatePreview() {
      const div = document.getElementById('previewRendered');
      const format = document.getElementById('formatSelect').value;
      if (format === 'markdown') {
        div.innerHTML = marked.parse(generatedBody);
      } else {
        div.innerHTML = generatedBody;
      }
    }

    // --- Tabs ---
    function switchTab(tab) {
      document.querySelectorAll('.preview-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      if (tab === 'rendered') {
        document.getElementById('previewRendered').style.display = '';
        document.getElementById('previewSource').style.display = 'none';
        // Sync edits back
        generatedBody = document.getElementById('sourceEditor').value;
        updatePreview();
      } else {
        document.getElementById('previewRendered').style.display = 'none';
        document.getElementById('previewSource').style.display = '';
      }
    }

    // --- Publish ---
    function setPublishFormat(fmt) {
      publishFormat = fmt;
      document.getElementById('fmtMd').classList.toggle('active', fmt === 'markdown');
      document.getElementById('fmtConf').classList.toggle('active', fmt === 'confluence');
    }

    async function publishToConfluence() {
      const title = document.getElementById('pageTitle').value.trim();
      if (!title) { alert('í˜ì´ì§€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }

      // Get latest edits
      generatedBody = document.getElementById('sourceEditor').value || generatedBody;

      const body = {
        title,
        body: generatedBody,
        space: document.getElementById('spaceSelect').value || undefined,
        parent_id: document.getElementById('parentSelect').value || undefined,
        use_markdown: publishFormat === 'markdown',
      };

      // Publishing progress
      const publishSteps = [
        { text: '1. Confluence ì—°ê²° ì¤‘...', status: 'active' },
        { text: '2. í˜ì´ì§€ ìƒì„± ì¤‘...', status: 'pending' },
        { text: '3. ì™„ë£Œ', status: 'pending' },
      ];
      setStatus('loading', 'ğŸ“¤ Confluenceì— ê²Œì‹œ ì¤‘...', { percent: 33, steps: publishSteps });

      try {
        const resp = await fetch('/api/publish', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(body),
        });

        // Update progress
        publishSteps[0].status = 'done';
        publishSteps[1].status = 'active';
        setStatus('loading', 'ğŸ“¤ í˜ì´ì§€ ìƒì„± ì¤‘...', { percent: 66, steps: publishSteps });

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${resp.status}): ${text.substring(0, 200)}`);
        }

        const data = await resp.json();

        if (data.ok) {
          publishSteps[1].status = 'done';
          publishSteps[2].status = 'done';
          setStatus('success', `âœ… ê²Œì‹œ ì™„ë£Œ! <a href="${data.url}" target="_blank" style="color: var(--success); text-decoration: underline;">${data.title}</a>`);
        } else {
          setStatus('error', `âŒ ê²Œì‹œ ì‹¤íŒ¨: ${data.error}`);
        }
      } catch (e) {
        setStatus('error', `âŒ ì˜¤ë¥˜: ${e.message}`);
      }
    }

    // --- Status ---
    function setStatus(type, msg, progress = null) {
      const el = document.getElementById('status');
      el.className = `status ${type}`;

      let html = msg;

      // Add progress bar if provided
      if (progress) {
        html += '<div class="progress-container">';
        html += `<div class="progress-bar"><div class="progress-fill" style="width: ${progress.percent}%"></div></div>`;

        if (progress.steps) {
          html += '<div class="progress-steps">';
          progress.steps.forEach(step => {
            const icon = step.status === 'done' ? 'âœ…' : step.status === 'active' ? 'â³' : 'âº';
            const cls = step.status === 'done' ? 'done' : step.status === 'active' ? 'active' : '';
            html += `<div class="progress-step ${cls}"><span class="icon">${icon}</span><span>${step.text}</span></div>`;
          });
          html += '</div>';
        }
        html += '</div>';
      }

      el.innerHTML = html;
    }

    function updateProgress(currentStep, totalSteps, stepName) {
      const percent = Math.round((currentStep / totalSteps) * 100);
      const steps = [
        { text: '1. ì†ŒìŠ¤ ì¶”ì¶œ ì¤‘...', status: currentStep > 1 ? 'done' : currentStep === 1 ? 'active' : 'pending' },
        { text: '2. LLM ì²˜ë¦¬ ì¤‘...', status: currentStep > 2 ? 'done' : currentStep === 2 ? 'active' : 'pending' },
        { text: '3. í¬ë§·íŒ… ì¤‘...', status: currentStep > 3 ? 'done' : currentStep === 3 ? 'active' : 'pending' },
      ];

      setStatus('loading', stepName, { percent, steps });
    }

    // --- LangExtract Visualization ---
    let lastVizHtml = '';

    async function runVisualization() {
      if (!sources.length) { alert('ì†ŒìŠ¤ë¥¼ ì¶”ê°€í•˜ì„¸ìš”'); return; }

      const btn = document.getElementById('vizBtn');
      btn.disabled = true;

      // LangExtract progress
      const vizSteps = [
        { text: '1. ì†ŒìŠ¤ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì¤‘...', status: 'active' },
        { text: '2. êµ¬ì¡°í™” ì •ë³´ ë¶„ì„ ì¤‘... (1-2ë¶„)', status: 'pending' },
        { text: '3. ì‹œê°í™” ìƒì„± ì¤‘...', status: 'pending' },
      ];
      setStatus('loading', 'ğŸ”¬ LangExtract ì²˜ë¦¬ ì¤‘...', { percent: 10, steps: vizSteps });

      try {
        const profile = document.getElementById('extractProfile').value;

        // Simulate extraction progress
        setTimeout(() => {
          vizSteps[0].status = 'done';
          vizSteps[1].status = 'active';
          setStatus('loading', 'ğŸ”¬ LangExtract ë¶„ì„ ì¤‘... (ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)', { percent: 40, steps: vizSteps });
        }, 500);

        const resp = await fetch('/api/extract_viz', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({sources, profile}),
        });

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${resp.status}): ${text.substring(0, 200)}`);
        }

        vizSteps[1].status = 'done';
        vizSteps[2].status = 'active';
        setStatus('loading', 'ğŸ”¬ ì‹œê°í™” ìƒì„± ì¤‘...', { percent: 80, steps: vizSteps });

        const data = await resp.json();

        if (data.ok) {
          lastVizHtml = data.html;
          document.getElementById('vizEntities').textContent =
            `ì¶”ì¶œëœ ì—”í‹°í‹°: ${data.entities_count}ê°œ`;

          // Save to sessionStorage for entity viewer
          sessionStorage.setItem('lastExtraction', JSON.stringify({
            sources: sources,
            profile: profile,
            timestamp: Date.now()
          }));

          // Load HTML into iframe
          const frame = document.getElementById('vizFrame');
          frame.srcdoc = data.html;

          vizSteps[2].status = 'done';
          document.getElementById('vizModal').classList.add('show');
          setStatus('success', `âœ… ì‹œê°í™” ì™„ë£Œ (${data.entities_count}ê°œ ì—”í‹°í‹° ì¶”ì¶œ)`);
        } else {
          setStatus('error', `âŒ ì¶”ì¶œ ì‹¤íŒ¨: ${data.error}`);
        }
      } catch (e) {
        setStatus('error', `âŒ ì˜¤ë¥˜: ${e.message}`);
      }

      btn.disabled = false;
    }

    function closeVizModal() {
      document.getElementById('vizModal').classList.remove('show');
    }

    function openVizNewTab() {
      if (!lastVizHtml) return;
      const w = window.open('', '_blank');
      w.document.write(lastVizHtml);
      w.document.close();
    }

    // --- Entities Viewer ---
    function openEntitiesViewer() {
      // Save current extraction context to sessionStorage
      if (sources.length > 0) {
        const useLangExtract = document.getElementById('useLangExtract').checked;
        const profile = document.getElementById('extractProfile').value;

        sessionStorage.setItem('lastExtraction', JSON.stringify({
          sources: sources,
          profile: profile,
          useLangExtract: useLangExtract,
          timestamp: Date.now()
        }));
      }

      window.open('/entities', '_blank');
    }

    // --- Confluence Space/Page ---
    async function loadSpaces() {
      try {
        const resp = await fetch('/api/confluence/spaces');
        if (!resp.ok) {
          // Hide Confluence publish section if not configured
          const publishSection = document.querySelector('.publish-section');
          if (publishSection) {
            publishSection.style.display = 'none';
          }
          return;
        }
        const spaces = await resp.json();
        if (spaces.error) {
          const publishSection = document.querySelector('.publish-section');
          if (publishSection) publishSection.style.display = 'none';
          return;
        }
        const sel = document.getElementById('spaceSelect');
        sel.innerHTML = '<option value="">Space ì„ íƒ...</option>' +
          spaces.map(s => `<option value="${s.key}">${s.key} - ${s.name}</option>`).join('');
      } catch(e) {
        // Hide Confluence section on error
        const publishSection = document.querySelector('.publish-section');
        if (publishSection) publishSection.style.display = 'none';
      }
    }

    async function onSpaceChange() {
      const space = document.getElementById('spaceSelect').value;
      const sel = document.getElementById('parentSelect');
      sel.innerHTML = '<option value="">ìƒìœ„ í˜ì´ì§€ (ìµœìƒìœ„)</option>';
      if (!space) return;

      try {
        const resp = await fetch(`/api/confluence/tree?space=${space}`);
        const tree = await resp.json();
        if (tree.error) return;

        for (const page of tree) {
          sel.innerHTML += `<option value="${page.id}">ğŸ“„ ${page.title}</option>`;
          if (page.children) {
            for (const child of page.children) {
              sel.innerHTML += `<option value="${child.id}">&nbsp;&nbsp;â”” ${child.title}</option>`;
            }
          }
        }
      } catch(e) {}
    }

    let searchTimeout;
    function debounceSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(searchPages, 500);
    }

    async function searchPages() {
      const query = document.getElementById('pageSearch').value.trim();
      if (!query || query.length < 2) return;
      const space = document.getElementById('spaceSelect').value;
      const url = `/api/confluence/search?q=${encodeURIComponent(query)}` + (space ? `&space=${space}` : '');
      try {
        const resp = await fetch(url);
        const results = await resp.json();
        if (results.error) return;
        const sel = document.getElementById('parentSelect');
        sel.innerHTML = '<option value="">ìƒìœ„ í˜ì´ì§€ (ìµœìƒìœ„)</option>' +
          results.map(p => `<option value="${p.id}">ğŸ” ${p.title}</option>`).join('');
      } catch(e) {}
    }

    // --- Init ---
    loadTemplates();
    loadSpaces();
  </script>
</body>
</html>
