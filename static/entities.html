<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ”¬ LangExtract ì—”í‹°í‹° ë·°ì–´</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0a0a0f;
      --surface: #1a1a2e;
      --surface2: #25254a;
      --surface3: #2f2f5a;
      --text: #e8e8f0;
      --text2: #a8a8c0;
      --text3: #787890;
      --accent: #ff6b9d;
      --accent2: #c44569;
      --success: #4ade80;
      --warn: #fbbf24;
      --info: #60a5fa;
      --purple: #a78bfa;
      --cyan: #22d3ee;
      --orange: #fb923c;

      /* Entity type colors */
      --entity-agenda: #8b5cf6;
      --entity-decision: #10b981;
      --entity-action: #f59e0b;
      --entity-statement: #3b82f6;
      --entity-feature: #06b6d4;
      --entity-architecture: #8b5cf6;
      --entity-requirement: #f97316;
      --entity-limitation: #ef4444;
      --entity-finding: #14b8a6;
      --entity-data: #6366f1;
      --entity-recommendation: #10b981;
      --entity-default: #64748b;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header */
    .header {
      background: var(--surface);
      border-radius: 16px;
      padding: 24px 32px;
      margin-bottom: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .header h1 {
      font-size: 2em;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .header p {
      color: var(--text2);
      font-size: 0.95em;
    }

    /* Controls */
    .controls {
      background: var(--surface);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .control-group {
      margin-bottom: 16px;
    }

    .control-group:last-child {
      margin-bottom: 0;
    }

    .control-group label {
      display: block;
      font-size: 0.85em;
      font-weight: 600;
      color: var(--text2);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .source-input-wrapper {
      display: flex;
      gap: 12px;
    }

    input[type="text"], select {
      background: var(--surface2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 0.95em;
      transition: all 0.2s;
      outline: none;
    }

    input[type="text"] {
      flex: 1;
    }

    input[type="text"]:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
    }

    select {
      width: 200px;
      cursor: pointer;
    }

    .btn {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 0.95em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 157, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: var(--surface2);
      box-shadow: none;
    }

    .btn-secondary:hover {
      background: var(--surface3);
      box-shadow: none;
    }

    .source-list {
      list-style: none;
      margin-top: 12px;
    }

    .source-item {
      background: var(--surface2);
      padding: 10px 16px;
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.9em;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .source-item .remove-btn {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: none;
      padding: 4px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85em;
      transition: all 0.2s;
    }

    .source-item .remove-btn:hover {
      background: rgba(239, 68, 68, 0.3);
    }

    /* Status */
    .status {
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 24px;
      font-size: 0.9em;
      display: none;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .status.show {
      display: block;
    }

    .status.loading {
      background: rgba(251, 191, 36, 0.1);
      color: var(--warn);
      border-color: rgba(251, 191, 36, 0.2);
    }

    .status.success {
      background: rgba(74, 222, 128, 0.1);
      color: var(--success);
      border-color: rgba(74, 222, 128, 0.2);
    }

    .status.error {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.2);
    }

    /* Stats */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--surface);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .stat-card .label {
      font-size: 0.8em;
      color: var(--text3);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 2em;
      font-weight: 700;
      background: linear-gradient(135deg, var(--purple) 0%, var(--cyan) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Entity Type Filter */
    .filter-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 24px;
    }

    .filter-chip {
      background: var(--surface2);
      color: var(--text2);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .filter-chip:hover {
      background: var(--surface3);
    }

    .filter-chip.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .filter-chip .count {
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.9em;
      font-weight: 600;
    }

    /* Entity Cards */
    .entities-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .entity-card {
      background: var(--surface);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      border-left: 4px solid var(--entity-default);
      transition: all 0.3s;
      border: 1px solid rgba(255, 255, 255, 0.05);
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .entity-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .entity-card.type-agenda { border-left-color: var(--entity-agenda); }
    .entity-card.type-decision { border-left-color: var(--entity-decision); }
    .entity-card.type-action_item { border-left-color: var(--entity-action); }
    .entity-card.type-key_statement { border-left-color: var(--entity-statement); }
    .entity-card.type-feature { border-left-color: var(--entity-feature); }
    .entity-card.type-architecture { border-left-color: var(--entity-architecture); }
    .entity-card.type-requirement { border-left-color: var(--entity-requirement); }
    .entity-card.type-limitation { border-left-color: var(--entity-limitation); }
    .entity-card.type-finding { border-left-color: var(--entity-finding); }
    .entity-card.type-data_point { border-left-color: var(--entity-data); }
    .entity-card.type-recommendation { border-left-color: var(--entity-recommendation); }

    .entity-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .entity-type {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(255, 255, 255, 0.05);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .entity-type .icon {
      font-size: 1.1em;
    }

    .entity-confidence {
      font-size: 0.8em;
      color: var(--text3);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .confidence-bar {
      width: 50px;
      height: 4px;
      background: var(--surface2);
      border-radius: 2px;
      overflow: hidden;
    }

    .confidence-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--warn), var(--success));
      border-radius: 2px;
      transition: width 0.3s;
    }

    .entity-content {
      font-size: 1.05em;
      line-height: 1.6;
      margin-bottom: 12px;
      color: var(--text);
      font-weight: 500;
    }

    .entity-fields {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .field-item {
      background: var(--surface2);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.85em;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .field-label {
      color: var(--text3);
      font-weight: 600;
      min-width: 80px;
      text-transform: capitalize;
    }

    .field-value {
      color: var(--text);
      flex: 1;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--text3);
    }

    .empty-state .icon {
      font-size: 4em;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .empty-state h3 {
      font-size: 1.3em;
      margin-bottom: 8px;
      color: var(--text2);
    }

    .empty-state p {
      font-size: 0.95em;
    }

    /* View Tabs */
    .view-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      padding: 4px;
      background: var(--surface);
      border-radius: 12px;
      width: fit-content;
    }

    .view-tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text2);
      font-size: 0.95em;
      cursor: pointer;
      transition: all 0.2s;
    }

    .view-tab:hover {
      background: var(--surface2);
      color: var(--text);
    }

    .view-tab.active {
      background: var(--accent);
      color: white;
    }

    /* Diagram View */
    .diagram-view {
      background: var(--surface);
      border-radius: 16px;
      padding: 24px;
      margin-top: 20px;
    }

    .diagram-controls {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--surface2);
      align-items: center;
      flex-wrap: wrap;
    }

    .diagram-controls label {
      font-size: 0.9em;
      color: var(--text);
      cursor: pointer;
    }

    .diagram-controls input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .diagram-container {
      background: var(--bg);
      border-radius: 12px;
      padding: 24px;
      overflow: auto;
      min-height: 400px;
      max-height: 80vh;
      position: relative;
    }

    .diagram-wrapper {
      display: inline-block;
      min-width: 100%;
      transform-origin: top left;
      transition: transform 0.3s ease;
    }

    .diagram-container .mermaid {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 350px;
    }

    .diagram-container .mermaid svg {
      max-width: none !important;
      height: auto !important;
    }

    /* Loader */
    .loader {
      border: 3px solid var(--surface2);
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .entities-grid {
        grid-template-columns: 1fr;
      }

      .stats {
        grid-template-columns: 1fr;
      }

      .header h1 {
        font-size: 1.5em;
      }
    }
  </style>
  <!-- Mermaid JS for diagram rendering -->
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
      startOnLoad: false,
      theme: 'dark',
      themeVariables: {
        primaryColor: '#8b5cf6',
        primaryTextColor: '#e8e8f0',
        primaryBorderColor: '#a78bfa',
        lineColor: '#60a5fa',
        secondaryColor: '#1a1a2e',
        tertiaryColor: '#25254a',
        background: '#0a0a0f',
        mainBkg: '#1a1a2e',
        textColor: '#e8e8f0',
        fontSize: '14px'
      }
    });
    window.mermaid = mermaid;
  </script>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>ğŸ”¬ LangExtract ì—”í‹°í‹° ë·°ì–´</h1>
      <p>êµ¬ì¡°í™”ëœ ì •ë³´ ì¶”ì¶œ ê²°ê³¼ë¥¼ ì‹œê°ì ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”</p>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="control-group">
        <label>ğŸ“¥ ì†ŒìŠ¤ ì…ë ¥</label>
        <div class="source-input-wrapper">
          <input type="text" id="sourceInput" placeholder="URL, ê²€ìƒ‰ì–´, íŒŒì¼ ê²½ë¡œ..." onkeydown="if(event.key==='Enter') addSource()">
          <select id="profileSelect">
            <option value="general">ì¼ë°˜</option>
            <option value="meeting">íšŒì˜ë¡</option>
            <option value="tech_review">ê¸°ìˆ  ë¦¬ë·°</option>
            <option value="research">ë¦¬ì„œì¹˜</option>
          </select>
          <button class="btn" onclick="addSource()">+</button>
        </div>
        <ul class="source-list" id="sourceList"></ul>
      </div>

      <div style="display: flex; gap: 12px;">
        <button class="btn" id="extractBtn" onclick="extractEntities()" disabled>
          ğŸ”¬ ì—”í‹°í‹° ì¶”ì¶œ
        </button>
        <button class="btn btn-secondary" onclick="clearResults()">
          ğŸ—‘ï¸ ì´ˆê¸°í™”
        </button>
      </div>
    </div>

    <!-- Status -->
    <div class="status" id="status"></div>

    <!-- Stats -->
    <div class="stats" id="stats" style="display: none;"></div>

    <!-- Filter Chips -->
    <div class="filter-chips" id="filterChips" style="display: none;"></div>

    <!-- View Tabs -->
    <div class="view-tabs" id="viewTabs" style="display: none;">
      <button class="view-tab active" onclick="switchView('cards')">ğŸ“‡ ì¹´ë“œ ë·°</button>
      <button class="view-tab" onclick="switchView('diagram')">ğŸ“Š ê´€ê³„ ë‹¤ì´ì–´ê·¸ë¨</button>
    </div>

    <!-- Entities Grid -->
    <div class="entities-grid" id="entitiesGrid">
      <div class="empty-state">
        <div class="icon">ğŸ“¦</div>
        <h3>ì—”í‹°í‹°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
        <p>ì†ŒìŠ¤ë¥¼ ì¶”ê°€í•˜ê³  ì—”í‹°í‹° ì¶”ì¶œì„ ì‹¤í–‰í•´ë³´ì„¸ìš”</p>
      </div>
    </div>

    <!-- Diagram View -->
    <div class="diagram-view" id="diagramView" style="display: none;">
      <div class="diagram-controls">
        <label style="display: flex; align-items: center; gap: 6px;">
          <input type="checkbox" id="showRelations" checked onchange="updateDiagram()"> ê´€ê³„ í‘œì‹œ
        </label>
        <label style="display: flex; align-items: center; gap: 6px;">
          <input type="checkbox" id="groupByType" checked onchange="updateDiagram()"> íƒ€ì…ë³„ ê·¸ë£¹í™”
        </label>
        <div style="flex: 1;"></div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <span style="font-size: 0.85em; color: var(--text2);">í¬ê¸°:</span>
          <button class="btn btn-secondary" onclick="zoomDiagram(-0.2)" title="ì¶•ì†Œ">ğŸ”-</button>
          <span id="zoomLevel" style="min-width: 60px; text-align: center; font-size: 0.9em;">100%</span>
          <button class="btn btn-secondary" onclick="zoomDiagram(0.2)" title="í™•ëŒ€">ğŸ”+</button>
          <button class="btn btn-secondary" onclick="resetZoom()" title="ì›ë˜ í¬ê¸°">â†º</button>
        </div>
        <button class="btn btn-secondary" onclick="copyDiagramCode()">ğŸ“‹ Mermaid ì½”ë“œ ë³µì‚¬</button>
        <button class="btn btn-secondary" onclick="downloadDiagramSVG()">ğŸ’¾ SVG ì €ì¥</button>
      </div>
      <div class="diagram-container" id="diagramContainer">
        <div class="diagram-wrapper" id="diagramWrapper">
          <pre class="mermaid" id="mermaidDiagram"></pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    let sources = [];
    let allEntities = [];
    let activeFilter = 'all';
    let currentView = 'cards';
    let mermaidCode = '';
    let currentZoom = 1.0;

    // Entity type metadata
    const entityTypes = {
      agenda: { icon: 'ğŸ“Œ', label: 'ì•ˆê±´', color: 'var(--entity-agenda)' },
      decision: { icon: 'âœ…', label: 'ê²°ì •ì‚¬í•­', color: 'var(--entity-decision)' },
      action_item: { icon: 'ğŸ“', label: 'ì•¡ì…˜ì•„ì´í…œ', color: 'var(--entity-action)' },
      key_statement: { icon: 'ğŸ’¬', label: 'ì¤‘ìš”ë°œì–¸', color: 'var(--entity-statement)' },
      feature: { icon: 'âš¡', label: 'ê¸°ëŠ¥', color: 'var(--entity-feature)' },
      architecture: { icon: 'ğŸ—ï¸', label: 'ì•„í‚¤í…ì²˜', color: 'var(--entity-architecture)' },
      requirement: { icon: 'ğŸ“‹', label: 'ìš”êµ¬ì‚¬í•­', color: 'var(--entity-requirement)' },
      limitation: { icon: 'âš ï¸', label: 'ì œí•œì‚¬í•­', color: 'var(--entity-limitation)' },
      example: { icon: 'ğŸ’¡', label: 'ì˜ˆì‹œ', color: 'var(--entity-feature)' },
      finding: { icon: 'ğŸ”', label: 'ë°œê²¬ì‚¬í•­', color: 'var(--entity-finding)' },
      data_point: { icon: 'ğŸ“Š', label: 'ë°ì´í„°', color: 'var(--entity-data)' },
      comparison: { icon: 'âš–ï¸', label: 'ë¹„êµ', color: 'var(--entity-architecture)' },
      recommendation: { icon: 'ğŸ’¡', label: 'ê¶Œê³ ì‚¬í•­', color: 'var(--entity-recommendation)' },
      reference: { icon: 'ğŸ“š', label: 'ì°¸ê³ ìë£Œ', color: 'var(--entity-statement)' },
      key_point: { icon: 'â­', label: 'í•µì‹¬ë‚´ìš©', color: 'var(--entity-finding)' },
      entity: { icon: 'ğŸ·ï¸', label: 'ê°œì²´', color: 'var(--entity-default)' },
      relation: { icon: 'ğŸ”—', label: 'ê´€ê³„', color: 'var(--entity-data)' },
    };

    // Add source
    function addSource() {
      const input = document.getElementById('sourceInput');
      const source = input.value.trim();
      if (!source) return;

      sources.push(source);
      input.value = '';
      updateSourceList();
    }

    function removeSource(index) {
      sources.splice(index, 1);
      updateSourceList();
    }

    function updateSourceList() {
      const list = document.getElementById('sourceList');
      const btn = document.getElementById('extractBtn');

      if (sources.length === 0) {
        list.innerHTML = '';
        btn.disabled = true;
        return;
      }

      btn.disabled = false;
      list.innerHTML = sources.map((s, i) => `
        <li class="source-item">
          <span>${s}</span>
          <button class="remove-btn" onclick="removeSource(${i})">ì‚­ì œ</button>
        </li>
      `).join('');
    }

    // Extract entities
    async function extractEntities() {
      const profile = document.getElementById('profileSelect').value;
      const btn = document.getElementById('extractBtn');

      btn.disabled = true;
      setStatus('loading', 'ğŸ”¬ ì—”í‹°í‹° ì¶”ì¶œ ì¤‘... (1-2ë¶„ ì†Œìš”)');

      try {
        const resp = await fetch('/api/extract_entities', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sources, profile }),
        });

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${resp.status}): ${text}`);
        }

        const data = await resp.json();

        if (!data.ok) {
          throw new Error(data.error);
        }

        allEntities = data.entities;
        displayResults(data);
        setStatus('success', `âœ… ì¶”ì¶œ ì™„ë£Œ! ${data.total_count}ê°œ ì—”í‹°í‹° ë°œê²¬`);

        // Show view tabs
        document.getElementById('viewTabs').style.display = 'flex';

        // Generate diagram
        generateDiagram();

      } catch (e) {
        setStatus('error', `âŒ ì˜¤ë¥˜: ${e.message}`);
      } finally {
        btn.disabled = false;
      }
    }

    // Display results
    function displayResults(data) {
      // Show stats
      const statsEl = document.getElementById('stats');
      statsEl.style.display = 'grid';

      const typeCounts = {};
      data.entities.forEach(e => {
        typeCounts[e.type] = (typeCounts[e.type] || 0) + 1;
      });

      const avgConfidence = data.entities.length > 0
        ? (data.entities.reduce((sum, e) => sum + e.confidence, 0) / data.entities.length * 100).toFixed(1)
        : 0;

      statsEl.innerHTML = `
        <div class="stat-card">
          <div class="label">ì´ ì—”í‹°í‹°</div>
          <div class="value">${data.total_count}</div>
        </div>
        <div class="stat-card">
          <div class="label">ì—”í‹°í‹° íƒ€ì…</div>
          <div class="value">${Object.keys(typeCounts).length}</div>
        </div>
        <div class="stat-card">
          <div class="label">í‰ê·  ì‹ ë¢°ë„</div>
          <div class="value">${avgConfidence}%</div>
        </div>
        <div class="stat-card">
          <div class="label">í”„ë¡œí•„</div>
          <div class="value" style="font-size: 1.3em;">${data.profile}</div>
        </div>
      `;

      // Show filter chips
      const chipsEl = document.getElementById('filterChips');
      chipsEl.style.display = 'flex';

      const chips = [
        { value: 'all', label: 'ì „ì²´', count: data.total_count },
        ...Object.entries(typeCounts).map(([type, count]) => ({
          value: type,
          label: entityTypes[type]?.label || type,
          count,
        })),
      ];

      chipsEl.innerHTML = chips.map(chip => `
        <div class="filter-chip ${chip.value === activeFilter ? 'active' : ''}"
             onclick="filterEntities('${chip.value}')">
          <span>${chip.label}</span>
          <span class="count">${chip.count}</span>
        </div>
      `).join('');

      // Display entities
      renderEntities(data.entities);
    }

    // Filter entities
    function filterEntities(type) {
      activeFilter = type;
      const filtered = type === 'all'
        ? allEntities
        : allEntities.filter(e => e.type === type);

      // Update chips
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.toggle('active', chip.textContent.includes(type) || (type === 'all' && chip.textContent.includes('ì „ì²´')));
      });

      renderEntities(filtered);
    }

    // Render entities
    function renderEntities(entities) {
      const grid = document.getElementById('entitiesGrid');

      if (entities.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="icon">ğŸ”</div>
            <h3>ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ë‹¤ë¥¸ í•„í„°ë¥¼ ì„ íƒí•´ë³´ì„¸ìš”</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = entities.map(entity => {
        const meta = entityTypes[entity.type] || { icon: 'ğŸ“„', label: entity.type };
        const confidence = (entity.confidence * 100).toFixed(0);

        const fieldsHtml = Object.keys(entity.fields).length > 0
          ? `<div class="entity-fields">
              ${Object.entries(entity.fields).map(([key, value]) => `
                <div class="field-item">
                  <span class="field-label">${key}</span>
                  <span class="field-value">${value}</span>
                </div>
              `).join('')}
            </div>`
          : '';

        return `
          <div class="entity-card type-${entity.type}">
            <div class="entity-header">
              <div class="entity-type">
                <span class="icon">${meta.icon}</span>
                <span>${meta.label}</span>
              </div>
              <div class="entity-confidence">
                <span>${confidence}%</span>
                <div class="confidence-bar">
                  <div class="confidence-fill" style="width: ${confidence}%"></div>
                </div>
              </div>
            </div>
            <div class="entity-content">${entity.content}</div>
            ${fieldsHtml}
          </div>
        `;
      }).join('');
    }

    // Clear results
    function clearResults() {
      sources = [];
      allEntities = [];
      activeFilter = 'all';
      currentView = 'cards';
      updateSourceList();
      document.getElementById('stats').style.display = 'none';
      document.getElementById('filterChips').style.display = 'none';
      document.getElementById('viewTabs').style.display = 'none';
      document.getElementById('entitiesGrid').innerHTML = `
        <div class="empty-state">
          <div class="icon">ğŸ“¦</div>
          <h3>ì—”í‹°í‹°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
          <p>ì†ŒìŠ¤ë¥¼ ì¶”ê°€í•˜ê³  ì—”í‹°í‹° ì¶”ì¶œì„ ì‹¤í–‰í•´ë³´ì„¸ìš”</p>
        </div>
      `;
      document.getElementById('diagramView').style.display = 'none';
      setStatus('', '');
    }

    // Switch View
    function switchView(view) {
      currentView = view;

      // Update tab states
      document.querySelectorAll('.view-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');

      // Toggle views
      if (view === 'cards') {
        document.getElementById('entitiesGrid').style.display = 'grid';
        document.getElementById('diagramView').style.display = 'none';
      } else {
        document.getElementById('entitiesGrid').style.display = 'none';
        document.getElementById('diagramView').style.display = 'block';
        updateDiagram();
      }
    }

    // Escape text for Mermaid
    function escapeMermaid(text) {
      return text
        .replace(/"/g, '#quot;')  // Replace quotes with HTML entity
        .replace(/\n/g, ' ')       // Remove newlines
        .replace(/\r/g, '')        // Remove carriage returns
        .replace(/\[/g, '#91;')    // Escape brackets
        .replace(/\]/g, '#93;')
        .replace(/\{/g, '#123;')   // Escape braces
        .replace(/\}/g, '#125;')
        .replace(/</g, '#lt;')     // Escape angle brackets
        .replace(/>/g, '#gt;')
        .replace(/&/g, '#amp;')    // Escape ampersand
        .replace(/\|/g, '#124;')   // Escape pipe
        .trim();
    }

    // Generate Mermaid diagram
    function generateDiagram() {
      const showRelations = document.getElementById('showRelations')?.checked ?? true;
      const groupByType = document.getElementById('groupByType')?.checked ?? true;

      if (groupByType) {
        mermaidCode = generateGroupedDiagram(showRelations);
      } else {
        mermaidCode = generateFlatDiagram(showRelations);
      }
    }

    function generateGroupedDiagram(showRelations) {
      let code = 'graph TB\n';

      // Group entities by type
      const byType = {};
      allEntities.forEach((e, idx) => {
        if (!byType[e.type]) byType[e.type] = [];
        byType[e.type].push({ ...e, id: `E${idx}` });
      });

      // Create subgraphs for each type
      Object.entries(byType).forEach(([type, entities]) => {
        const meta = entityTypes[type] || { label: type, icon: 'ğŸ“„' };
        code += `\n  subgraph ${type}["${meta.icon} ${meta.label}"]\n`;

        entities.forEach(e => {
          const content = e.content.length > 40 ? e.content.substring(0, 40) + '...' : e.content;
          const escaped = escapeMermaid(content);
          code += `    ${e.id}["${escaped}"]\n`;
        });

        code += `  end\n`;
      });

      // Add relationships if enabled
      if (showRelations) {
        code += '\n  %% Relationships\n';

        // Find relationships based on entity fields and content
        allEntities.forEach((e1, i) => {
          allEntities.forEach((e2, j) => {
            if (i >= j) return;

            // Check if entities are related
            const related = isRelated(e1, e2);
            if (related) {
              code += `  E${i} -.-> E${j}\n`;
            }
          });
        });
      }

      // Styling
      code += '\n  classDef default fill:#1a1a2e,stroke:#8b5cf6,stroke-width:2px,color:#e8e8f0\n';

      return code;
    }

    function generateFlatDiagram(showRelations) {
      let code = 'graph LR\n';

      // Add all entities
      allEntities.forEach((e, idx) => {
        const meta = entityTypes[e.type] || { icon: 'ğŸ“„' };
        const content = e.content.length > 30 ? e.content.substring(0, 30) + '...' : e.content;
        const escaped = escapeMermaid(content);
        code += `  E${idx}["${meta.icon} ${escaped}"]\n`;
      });

      // Add relationships if enabled
      if (showRelations) {
        code += '\n  %% Relationships\n';

        allEntities.forEach((e1, i) => {
          allEntities.forEach((e2, j) => {
            if (i >= j) return;

            const related = isRelated(e1, e2);
            if (related) {
              code += `  E${i} --> E${j}\n`;
            }
          });
        });
      }

      // Styling by type
      Object.keys(entityTypes).forEach(type => {
        const indices = allEntities
          .map((e, i) => e.type === type ? `E${i}` : null)
          .filter(x => x)
          .join(',');

        if (indices) {
          const color = entityTypes[type].color || 'var(--entity-default)';
          code += `  class ${indices} ${type}Class\n`;
        }
      });

      return code;
    }

    // Check if two entities are related
    function isRelated(e1, e2) {
      // Simple heuristic: check if they share significant words
      const words1 = new Set(e1.content.toLowerCase().split(/\s+/).filter(w => w.length > 3));
      const words2 = new Set(e2.content.toLowerCase().split(/\s+/).filter(w => w.length > 3));

      const commonWords = [...words1].filter(w => words2.has(w));

      // Related if they share 2+ significant words or same field values
      if (commonWords.length >= 2) return true;

      // Check field overlaps
      const fields1 = Object.values(e1.fields).map(v => String(v).toLowerCase());
      const fields2 = Object.values(e2.fields).map(v => String(v).toLowerCase());

      return fields1.some(f1 => fields2.includes(f1));
    }

    // Update diagram rendering
    async function updateDiagram() {
      generateDiagram();

      const container = document.getElementById('mermaidDiagram');
      container.textContent = mermaidCode;
      container.removeAttribute('data-processed');

      try {
        await window.mermaid.run({ nodes: [container] });

        // Reset zoom when diagram changes
        currentZoom = 1.0;
        applyZoom();
      } catch (e) {
        console.error('Mermaid rendering error:', e);
        container.innerHTML = `<div style="color: var(--warn); padding: 20px;">
          âš ï¸ ë‹¤ì´ì–´ê·¸ë¨ ë Œë”ë§ ì˜¤ë¥˜<br>
          <small>${e.message}</small>
        </div>`;
      }
    }

    // Copy diagram code
    async function copyDiagramCode() {
      try {
        await navigator.clipboard.writeText(mermaidCode);
        const btn = event.target;
        const orig = btn.innerHTML;
        btn.innerHTML = 'âœ… ë³µì‚¬ë¨!';
        setTimeout(() => btn.innerHTML = orig, 2000);
      } catch (e) {
        alert('ë³µì‚¬ ì‹¤íŒ¨: ' + e.message);
      }
    }

    // Download diagram as SVG
    async function downloadDiagramSVG() {
      try {
        const svg = document.querySelector('#mermaidDiagram svg');
        if (!svg) {
          alert('ë‹¤ì´ì–´ê·¸ë¨ì´ ë Œë”ë§ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
          return;
        }

        const svgData = new XMLSerializer().serializeToString(svg);
        const blob = new Blob([svgData], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `entity_diagram_${new Date().toISOString().slice(0, 10)}.svg`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (e) {
        alert('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
      }
    }

    // Zoom controls
    function zoomDiagram(delta) {
      currentZoom = Math.max(0.2, Math.min(5.0, currentZoom + delta));
      applyZoom();
    }

    function resetZoom() {
      currentZoom = 1.0;
      applyZoom();
    }

    function applyZoom() {
      const wrapper = document.getElementById('diagramWrapper');
      if (wrapper) {
        wrapper.style.transform = `scale(${currentZoom})`;
      }

      // Update zoom level display
      const zoomLabel = document.getElementById('zoomLevel');
      if (zoomLabel) {
        zoomLabel.textContent = `${Math.round(currentZoom * 100)}%`;
      }

      // Adjust container scroll if needed
      const container = document.getElementById('diagramContainer');
      if (container && currentZoom > 1) {
        // Ensure scrollbars appear when zoomed in
        container.style.overflow = 'auto';
      }
    }

    // Set status
    function setStatus(type, msg) {
      const el = document.getElementById('status');
      el.className = `status ${type} ${type ? 'show' : ''}`;
      el.innerHTML = msg;
    }

    // Auto-load from sessionStorage on page load
    window.addEventListener('DOMContentLoaded', () => {
      const lastExtraction = sessionStorage.getItem('lastExtraction');
      if (lastExtraction) {
        try {
          const data = JSON.parse(lastExtraction);
          const age = Date.now() - data.timestamp;

          // Auto-load if less than 5 minutes old
          if (age < 5 * 60 * 1000) {
            sources = data.sources || [];
            document.getElementById('profileSelect').value = data.profile || 'general';
            updateSourceList();

            // Show info banner
            setStatus('loading', `ğŸ“¥ ë©”ì¸ UIì—ì„œ ì „ë‹¬ëœ ì†ŒìŠ¤ ${sources.length}ê°œë¥¼ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. "ì—”í‹°í‹° ì¶”ì¶œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.`);

            // Auto-extract after 1 second
            setTimeout(() => {
              if (sources.length > 0) {
                extractEntities();
              }
            }, 1000);
          }
        } catch (e) {
          console.error('Failed to load last extraction:', e);
        }
      }
    });
  </script>
</body>
</html>
